<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proto TV</title>
  <link rel="icon" href="img/icon.png" type="image/png">
  <style>
    @font-face { font-family: 'CalSans'; src: url('fonts/CalSans-Regular.ttf') format('opentype'); }
    @font-face { font-family: 'DMSans'; src: url('fonts/DMSans-Regular.ttf') format('truetype'); }
    body {
      font-family: 'DMSans', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen;
      /* background-color: #001029; */ /* Eliminamos el color sólido */
      background-color: transparent; /* Hacemos el fondo del body transparente */
      margin: 0; padding: 40px 20px; padding-top: 100px;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh; position: relative; /* Mantenemos position: relative */
      color: #333;
      z-index: 1; /* Asegura que el contenido esté sobre el fondo desenfocado */
    }
    body::before {
      content: ''; /* Requerido para pseudo-elementos */
      position: fixed; /* Fija el fondo a la ventana */
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%;
      background-image: url('img/background.webp'); /* Establece la imagen de fondo */
      background-size: cover; /* Cubre todo el área */
      background-position: center; /* Centra la imagen */
      filter: blur(20px); /* Aplica el desenfoque */
      transform: scale(1.1); /* Escala la imagen para ocultar bordes borrosos */
      z-index: -1; /* Coloca el pseudo-elemento detrás del contenido del body */
    }
    .site-logo-link { position: absolute; top: 20px; left: 20px; z-index: 10; }
    .site-logo-link img { height: 42px; width: auto; display: block; } /* Altura reducida */
    h1 { 
      font-family: 'CalSans', sans-serif; 
      text-align: center; 
      color: #fff; 
      margin: 0 0 40px; 
      font-size: 37px; /* Tamaño aumentado (aplicado a todos los tamaños) */
      letter-spacing: 2px; /* Interletrado añadido (aplicado a todos los tamaños) */
    }
    /* Estilo para la cuadrícula de canales, se aplicará a cada sección */
    .channel-grid { 
      display: flex; 
      justify-content: center; 
      gap: 30px; 
      flex-wrap: wrap; 
      max-width: 900px; 
      width: 100%; 
      margin-bottom: 40px; 
    }
    .channel-item { text-decoration: none; color: inherit; text-align: center; transition: transform 0.2s; display: flex; flex-direction: column; }
    .channel-item:hover { transform: translateY(-5px); }
    .channel-item img { 
      width: 180px; /* Mantenemos el ancho deseado */
      height: auto; /* Ajustamos la altura automáticamente */
      object-fit: cover; /* Mantenemos cover por si acaso, pero con height:auto no debería ser necesario */
      border-radius: 12px; 
    }
    #agenda-container { width: 100%; max-width: 900px; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; }
    #agenda-container h2 { margin-top: 0; color: #ef0a6a; text-align: center; }
    #agenda-table { width: 100%; border-collapse: collapse; }
    #agenda-table th, #agenda-table td { border: 1px solid #ddd; padding: 8px; }
    #agenda-table th { background: #f5f5f5; }
    /* Estilos para las nuevas tablas de agenda (una por competición) */
    .styled-agenda-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    .styled-agenda-table th, .styled-agenda-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    .styled-agenda-table th { background: #f5f5f5; }
    .styled-agenda-table td:nth-child(2) { text-align: center; } /* Centrar Horario */
    @media (max-width: 700px) {
      body { padding: 20px 15px; padding-top: 90px; }
      .site-logo-link { position: absolute; top: 15px; left: 15px; } /* Ajustado para móvil */
      .site-logo-link img { height: 42px; } /* Tamaño de logo para móvil */
      h1 { 
        font-size: 1.8em; /* Tamaño específico para móvil */ 
        margin-bottom: 30px; 
        /* Ya no se necesita font-family, text-align, color, letter-spacing aquí si son iguales al general */
      }
      /* Ajuste para la cuadrícula de canales en móvil */
      .channel-grid { 
        gap: 15px; 
        justify-content: space-around; 
      }
      .channel-item img { 
        width: 126px; /* Ancho para móvil */
        height: auto; /* Altura automática también para móvil */
      }
      #agenda-container { padding: 15px; }
    }
  </style>
</head>
<body>
  <a href="index.html" class="site-logo-link">
    <img src="img/logo.png" loading="lazy">
  </a>

  <div id="sections-container"></div>

  <section id="agenda-container">
    <h2>Cargando agenda...</h2>
  </section>

  <script>
    // --- Definición de Secciones y Canales ---
    const siteSections = [
      {
        title: "DEPORTES",
        channels: [
          { name: "DIRECTV Sports", image: "img/directv_sports.png", url: "sports-channel/directv_sports.html" },
          { name: "TNT Sports", image: "img/tnt_sports.png", url: "sports-channel/tnt_sports.html" },
          { name: "ESPN", image: "img/espn.png", url: "sports-channel/espn.html" },
          { name: "TyC Sports", image: "img/tyc_sports.png", url: "sports-channel/tyc_sports.html" },
          { name: "Fox Sports Premium", image: "img/fox_sports_premium.png", url: "sports-channel/fox_sports.html" }
        ]
      },
      // Puedes añadir más secciones aquí, por ejemplo:
      // {
      //   title: "NOTICIAS",
      //   channels: [
      //     { name: "Noticias Canal 1", image: "img/noticias1.png", url: "news-channel/noticias1.html" },
      //     { name: "Noticias Canal 2", image: "img/noticias2.png", url: "news-channel/noticias2.html" }
      //   ]
      // }
    ];

    function renderSections() {
      const sectionsContainer = document.getElementById('sections-container');
      sectionsContainer.innerHTML = ''; // Limpiar contenido previo

      siteSections.forEach(section => {
        // Crear título de la sección
        const sectionTitle = document.createElement('h1');
        sectionTitle.textContent = section.title;
        sectionsContainer.appendChild(sectionTitle);

        // Crear contenedor para los canales de esta sección
        const channelGrid = document.createElement('div');
        channelGrid.className = 'channel-grid'; // Usar la clase CSS existente

        section.channels.forEach(channel => {
          const channelLink = document.createElement('a');
          channelLink.href = channel.url;
          channelLink.className = 'channel-item';

          const channelImage = document.createElement('img');
          channelImage.src = channel.image;
          channelImage.alt = channel.name; // Usar el nombre del canal como alt text
          channelImage.loading = 'lazy';

          channelLink.appendChild(channelImage);
          channelGrid.appendChild(channelLink);
        });

        sectionsContainer.appendChild(channelGrid);
      });
    }

    async function updateAgenda() {
      const container = document.getElementById('agenda-container');
      // Mostrar mensaje de carga inicial o al actualizar
      container.innerHTML = '<h2>Cargando agenda...</h2>'; 

      try {
        // const proxy = 'https://api.allorigins.win/raw?url='; // Proxy 1
        // const proxy = 'https://corsproxy.io/?'; // Proxy 2
        // const proxy = 'https://thingproxy.freeboard.io/fetch/'; // Proxy 3
        const proxy = 'https://api.codetabs.com/v1/proxy/?quest='; // Proxy 4
        const targetUrl = 'https://www.futbolenvivoargentina.com/';

        const response = await fetch(proxy + targetUrl); // Para api.codetabs, la URL se pasa como parámetro 'quest'
        if (!response.ok) {
          throw new Error(`Error al cargar datos desde ${targetUrl}: ${response.statusText}`);
        }

        const htmlText = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, 'text/html');

        const parsedData = {
          pageTitle: 'Agenda Deportiva', // Título por defecto
          competitions: []
        };

        let currentCompetitionMatches = null;
        let currentCompetitionName = null;

        const tbody = doc.querySelector('table tbody');
        if (!tbody) {
            throw new Error('No se encontró el tbody principal en la página fuente.');
        }

        const rows = Array.from(tbody.querySelectorAll('tr'));

        for (const row of rows) {
          if (row.classList.contains('cabeceraTabla')) {
            const td = row.querySelector('td');
            if (td) {
                // Extraer el texto, eliminando el contenido de los spans si existen (como "AYER", "HOY", "MAÑANA")
                const cloneTd = td.cloneNode(true);
                cloneTd.querySelectorAll('span').forEach(span => span.remove());
                parsedData.pageTitle = cloneTd.textContent.trim();
            }
          } else if (row.classList.contains('cabeceraCompericion')) {
            if (currentCompetitionName && currentCompetitionMatches && currentCompetitionMatches.length > 0) {
              parsedData.competitions.push({ name: currentCompetitionName, matches: currentCompetitionMatches });
            }
            currentCompetitionMatches = []; // Reiniciar para la nueva competición

            const td = row.querySelector('td');
            let isArgentinianCompetition = false;
            if (td) {
                const competitionImg = td.querySelector('img.js-webp-default'); // Selector de la imagen de la competición
                if (competitionImg) {
                    const imgSrc = (competitionImg.getAttribute('src') || '').toLowerCase();
                    const altImgSrc = (competitionImg.getAttribute('alt-img') || '').toLowerCase();
                    // Verificamos si en el src o alt-img de la imagen aparece "-argentina." o "/argentina."
                    if (imgSrc.includes('-argentina.') || imgSrc.includes('/argentina.') || altImgSrc.includes('-argentina.') || altImgSrc.includes('/argentina.')) {
                        isArgentinianCompetition = true;
                    }
                }
            }

            if (isArgentinianCompetition) {
              const a = td.querySelector('a.internalLink'); // Hacemos el selector del enlace un poco más específico
              currentCompetitionName = a ? a.textContent.trim() : 'Competición Argentina';
            } else {
              currentCompetitionName = null; // No es una competición argentina de interés
            }
          } else if (!row.className && currentCompetitionName && currentCompetitionMatches) { // Fila de partido y estamos en una competición argentina
            const horaEl = row.querySelector('td.hora');
            const localImgEl = row.querySelector('td.local img');
            const visitanteImgEl = row.querySelector('td.visitante img');
            const canalesUlEl = row.querySelector('td.canales ul');

            if (horaEl && localImgEl && visitanteImgEl) {
              const time = horaEl.textContent.trim();
              const local = localImgEl.alt.trim();
              const visitor = visitanteImgEl.alt.trim();
              let channelsText = '-';
              if (canalesUlEl) {
                const channelItems = Array.from(canalesUlEl.querySelectorAll('li'))
                                          .map(li => li.textContent.trim())
                                          .filter(ch => ch); // Filtrar vacíos si los hubiera
                if (channelItems.length > 0) {
                  channelsText = channelItems.join(', ');
                }
              }
              currentCompetitionMatches.push({ time, local, visitor, channels: channelsText });
            }
          }
        }

        // Añadir la última competición recolectada si existe
        if (currentCompetitionName && currentCompetitionMatches && currentCompetitionMatches.length > 0) {
          parsedData.competitions.push({ name: currentCompetitionName, matches: currentCompetitionMatches });
        }

        // Renderizar los datos
        container.innerHTML = ''; 

        const mainTitle = document.createElement('h2');
        mainTitle.textContent = parsedData.pageTitle;
        mainTitle.style.color = '#ef0a6a'; // Estilo del título principal de la agenda
        mainTitle.style.textAlign = 'center';
        container.appendChild(mainTitle);

        if (parsedData.competitions.length === 0) {
          const noDataP = document.createElement('p');
          noDataP.textContent = 'No hay partidos de ligas argentinas para hoy.';
          noDataP.style.textAlign = 'center';
          noDataP.style.padding = '20px 0';
          container.appendChild(noDataP);
        } else {
          parsedData.competitions.forEach(competition => {
            const competitionTitle = document.createElement('h3');
            competitionTitle.textContent = competition.name; // "Categoría"
            competitionTitle.style.color = '#333'; // Un color diferente para la categoría
            competitionTitle.style.textAlign = 'center';
            competitionTitle.style.marginTop = '25px';
            competitionTitle.style.marginBottom = '10px';
            container.appendChild(competitionTitle);

            const table = document.createElement('table');
            table.className = 'styled-agenda-table'; // Usar la nueva clase para estilos

            const thead = document.createElement('thead');
            const headRow = document.createElement('tr');
            ['Partido', 'Horario', 'Canales'].forEach(txt => {
              const th = document.createElement('th');
              th.textContent = txt;
              headRow.appendChild(th);
            });
            thead.appendChild(headRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            competition.matches.forEach(match => {
              const tr = document.createElement('tr');

              const tdMatch = document.createElement('td');
              tdMatch.textContent = `${match.local} vs ${match.visitor}`;

              const tdTime = document.createElement('td');
              tdTime.textContent = match.time;

              const tdChan = document.createElement('td');
              tdChan.textContent = match.channels;

              tr.append(tdMatch, tdTime, tdChan);
              tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            container.appendChild(table);
          });
        }

      } catch (err) {
        // Manejo de errores (si fallan todas las peticiones o hay otro error)
        container.innerHTML = ''; // Limpiar por si acaso
        const title = document.createElement('h2');
        title.textContent = 'Agenda Deportiva'; // Título genérico en caso de error
        title.style.color = '#ef0a6a';
        title.style.textAlign = 'center';
        container.appendChild(title);
        const errorP = document.createElement('p');
        errorP.textContent = 'Error al cargar la agenda.';
        errorP.className = 'error-message'; 
        errorP.style.textAlign = 'center';
        errorP.style.padding = '20px 0';
        container.appendChild(errorP);
        console.error('Error actualizando agenda:', err);
      }
    }

    // Llama a la función para renderizar secciones al cargar la página
    renderSections();

    // Llama a la función inmediatamente para cargar la agenda al inicio
    updateAgenda();

    // Establece un intervalo para llamar a updateAgenda cada minuto (60000 ms)
    setInterval(updateAgenda, 60000);
  </script>
</body>
</html>
