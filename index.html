<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proto TV</title>
  <link rel="icon" href="img/icon.png" type="image/png">
  <style>
    @font-face { font-family: 'CalSans'; src: url('fonts/CalSans-Regular.ttf') format('opentype'); }
    @font-face { font-family: 'DMSans'; src: url('fonts/DMSans-Regular.ttf') format('truetype'); }
    body {
      font-family: 'DMSans', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen;
      /* background-color: #001029; */ /* Eliminamos el color sólido */
      background-color: transparent; /* Hacemos el fondo del body transparente */
      margin: 0; padding: 40px 20px; padding-top: 100px;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh; position: relative; /* Mantenemos position: relative */
      color: #333;
      z-index: 1; /* Asegura que el contenido esté sobre el fondo desenfocado */
    }
    body::before {
      content: ''; /* Requerido para pseudo-elementos */
      position: fixed; /* Fija el fondo a la ventana */
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%;
      background-image: url('img/background.webp'); /* Establece la imagen de fondo */
      background-size: cover; /* Cubre todo el área */
      background-position: center; /* Centra la imagen */
      filter: blur(20px); /* Aplica el desenfoque */
      transform: scale(1.1); /* Escala la imagen para ocultar bordes borrosos */
      z-index: -1; /* Coloca el pseudo-elemento detrás del contenido del body */
    }
    .site-logo-link { position: absolute; top: 20px; left: 20px; z-index: 10; }
    .site-logo-link img { height: 42px; width: auto; display: block; } /* Altura reducida */
    h1 { 
      font-family: 'CalSans', sans-serif; 
      text-align: center; 
      color: #fff; 
      margin: 0 0 40px; 
      font-size: 37px; /* Tamaño aumentado (aplicado a todos los tamaños) */
      letter-spacing: 2px; /* Interletrado añadido (aplicado a todos los tamaños) */
    }
    #channel-grid { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; max-width: 900px; width: 100%; margin-bottom: 40px; }
    .channel-item { text-decoration: none; color: inherit; text-align: center; transition: transform 0.2s; display: flex; flex-direction: column; }
    .channel-item:hover { transform: translateY(-5px); }
    .channel-item img { 
      width: 180px; /* Mantenemos el ancho deseado */
      height: auto; /* Ajustamos la altura automáticamente */
      object-fit: cover; /* Mantenemos cover por si acaso, pero con height:auto no debería ser necesario */
      border-radius: 12px; 
    }
    #agenda-container { width: 100%; max-width: 900px; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; }
    #agenda-container h2 { margin-top: 0; color: #ef0a6a; text-align: center; }
    #agenda-table { width: 100%; border-collapse: collapse; }
    #agenda-table th, #agenda-table td { border: 1px solid #ddd; padding: 8px; }
    #agenda-table th { background: #f5f5f5; }
    @media (max-width: 700px) {
      body { padding: 20px 15px; padding-top: 90px; }
      .site-logo-link { position: absolute; top: 15px; left: 15px; } /* Ajustado para móvil */
      .site-logo-link img { height: 42px; } /* Tamaño de logo para móvil */
      h1 { 
        font-size: 1.8em; /* Tamaño específico para móvil */ 
        margin-bottom: 30px; 
        /* Ya no se necesita font-family, text-align, color, letter-spacing aquí si son iguales al general */
      }
      #channel-grid { gap: 15px; justify-content: space-around; }
      .channel-item img { 
        width: 126px; /* Ancho para móvil */
        height: auto; /* Altura automática también para móvil */
      }
      #agenda-container { padding: 15px; }
    }
  </style>
</head>
<body>
  <a href="index.html" class="site-logo-link">
    <img src="img/logo.png" loading="lazy">
  </a>
  <h1>DEPORTES</h1>

  <div id="channel-grid">
    <a href="sports-channel/directv_sports.html" class="channel-item">
      <img src="img/directv_sports.png" loading="lazy">
    </a>
    <a href="sports-channel/tnt_sports.html" class="channel-item">
      <img src="img/tnt_sports.png" loading="lazy">
    </a>
    <a href="sports-channel/espn.html" class="channel-item">
      <img src="img/espn.png" loading="lazy">
    </a>
    <a href="sports-channel/tyc_sports.html" class="channel-item">
      <img src="img/tyc_sports.png" loading="lazy">
    </a>
    <a href="sports-channel/fox_sports.html" class="channel-item">
      <img src="img/fox_sports_premium.png" loading="lazy">
    </a>
  </div>

  <section id="agenda-container">
    <h2>Cargando agenda...</h2>
  </section>

  <script>
    async function updateAgenda() {
      const container = document.getElementById('agenda-container');
      // Mostrar mensaje de carga inicial o al actualizar
      container.innerHTML = '<h2>Cargando agenda...</h2>'; 

      try {
        const proxy = 'https://api.allorigins.win/raw?url=';
        const targetUrls = [
          'https://pelota-libre.org/agenda/',
          'https://tvlibreonline.me/agenda/' 
        ];

        // Fetch data from all sources concurrently
        const responses = await Promise.all(
          targetUrls.map(url => fetch(proxy + encodeURIComponent(url)))
        );

        // Process all responses
        let allEntries = [];
        let headerText = 'Agenda deportiva'; // Default header

        for (const resp of responses) {
          if (!resp.ok) {
            console.warn(`Fallo al cargar desde: ${resp.url}`);
            continue; // Saltar a la siguiente URL si una falla
          }
          const htmlText = await resp.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(htmlText, 'text/html');

          // Intentar obtener el encabezado (usar el primero que se encuentre)
          const centerEl = doc.querySelector('center');
          if (centerEl && headerText === 'Agenda deportiva') { // Tomar el primer encabezado válido
             headerText = centerEl.textContent.trim();
          }

          // Extraer entradas de esta fuente
          const entries = Array.from(doc.querySelectorAll('li.AR, li.CHA, li.SUD, li.LIB'));
          allEntries = allEntries.concat(entries); // Añadir entradas a la lista combinada
        }
        
        // Limpiar contenedor antes de añadir contenido nuevo (excepto si hubo error total)
        container.innerHTML = ''; 

        const title = document.createElement('h2');
        title.textContent = headerText;
        container.appendChild(title);

        // Eliminar duplicados basados en el texto del partido y hora (opcional pero recomendado)
        const uniqueEntriesData = {};
        const uniqueEntries = [];
        allEntries.forEach(li => {
            const mainA = li.querySelector('a:not([target])');
            if (!mainA) return;
            const spanTime = mainA.querySelector('span.t');
            const timeText = spanTime ? spanTime.textContent.trim() : '';
            let matchText = mainA.textContent.trim();
            const parts = matchText.split(/\s+/);
            if (!/^[A-Za-zÀ-ÖØ-öø-ÿ]/.test(parts[0])) parts.shift();
            matchText = parts.join(' ').replace(/^Superliga Argentina:\s*/, '');
            
            const key = `${matchText}|${timeText}`; // Clave única por partido y hora
            if (!uniqueEntriesData[key]) {
                uniqueEntriesData[key] = true;
                uniqueEntries.push(li); // Añadir solo si no existe la clave
            }
        });


        // Comprobar si hay entradas únicas
        if (uniqueEntries.length === 0) {
          // Si no hay entradas, mostrar mensaje
          const noDataDiv = document.createElement('p');
          noDataDiv.textContent = 'No hay partidos para hoy';
          noDataDiv.style.textAlign = 'center';
          noDataDiv.style.padding = '20px 0';
          container.appendChild(noDataDiv);
        } else {
          // Si hay entradas, crear y llenar la tabla
          const table = document.createElement('table');
          table.id = 'agenda-table';

          const thead = document.createElement('thead');
          const headRow = document.createElement('tr');
          ['Partido', 'Horario', 'Canales'].forEach(txt => {
            const th = document.createElement('th'); th.textContent = txt; headRow.appendChild(th);
          });
          thead.appendChild(headRow);
          table.appendChild(thead);

          const tbody = document.createElement('tbody');

          uniqueEntries.forEach(li => { // Iterar sobre las entradas únicas
            const mainA = li.querySelector('a:not([target])');
            if (!mainA) return; 

            // Extraer span de tiempo
            const spanTime = mainA.querySelector('span.t');
            const tdTime = document.createElement('td');
            if (spanTime) {
              // --- Inicio: Ajuste de Hora ---
              const originalTime = spanTime.textContent.trim(); // Ej: "01:10"
              const timeParts = originalTime.split(':');
              if (timeParts.length === 2) {
                let hour = parseInt(timeParts[0], 10);
                const minute = parseInt(timeParts[1], 10);

                if (!isNaN(hour) && !isNaN(minute)) {
                  // Restar 4 horas y manejar el cruce de medianoche
                  hour = (hour - 4 + 24) % 24; 

                  // Formatear a HH:MM con ceros iniciales si es necesario
                  const adjustedHourStr = hour.toString().padStart(2, '0');
                  const minuteStr = minute.toString().padStart(2, '0');
                  tdTime.textContent = `${adjustedHourStr}:${minuteStr}`;
                } else {
                  tdTime.textContent = originalTime; // Mostrar original si el parseo falla
                }
              } else {
                tdTime.textContent = originalTime; // Mostrar original si el formato no es HH:MM
              }
              // --- Fin: Ajuste de Hora ---
            } else {
              tdTime.textContent = '';
            }

            // --- Inicio: Corrección Texto del Partido ---
            // Clonar el nodo 'a' para manipularlo sin afectar el original para la hora
            const linkClone = mainA.cloneNode(true);
            const timeSpanInClone = linkClone.querySelector('span.t');
            if (timeSpanInClone) {
              timeSpanInClone.remove(); // Eliminar el span de tiempo del clon
            }
            let text = linkClone.textContent.trim(); // Obtener texto sin el horario
            // --- Fin: Corrección Texto del Partido ---

            const parts = text.split(/\s+/);
            // Eliminar prefijos numéricos o de tiempo residuales si los hubiera
            while (parts.length > 0 && !/^[A-Za-zÀ-ÖØ-öø-ÿ]/.test(parts[0])) {
                 parts.shift();
            }
            text = parts.join(' ').replace(/^Superliga Argentina:\s*/, ''); // Limpiar nombre de liga
            const tdMatch = document.createElement('td');
            tdMatch.textContent = text;

            // Extraer canales (sin cambios)
            const channelLinks = Array.from(li.querySelectorAll('ul > li.subitem1 > a'));
            const channels = channelLinks.map(a => {
              const sp = a.querySelector('span'); if (sp) sp.remove();
              return a.textContent.trim();
            });
            const tdChan = document.createElement('td');
            tdChan.textContent = channels.length ? channels.join(', ') : '-';

            const tr = document.createElement('tr');
            tr.append(tdMatch, tdTime, tdChan);
            tbody.appendChild(tr);
          });

          table.appendChild(tbody);
          container.appendChild(table);
        }

      } catch (err) {
        // Manejo de errores (si fallan todas las peticiones o hay otro error)
        container.innerHTML = ''; // Limpiar por si acaso
        const title = document.createElement('h2');
        title.textContent = 'Agenda deportiva'; // Título genérico en caso de error
        container.appendChild(title);
        const errorP = document.createElement('p');
        errorP.textContent = 'Error al cargar la agenda.';
        errorP.className = 'error-message'; 
        errorP.style.textAlign = 'center';
        errorP.style.padding = '20px 0';
        container.appendChild(errorP);
        console.error('Error actualizando agenda:', err);
      }
    }

    // Llama a la función inmediatamente para cargar la agenda al inicio
    updateAgenda();

    // Establece un intervalo para llamar a updateAgenda cada minuto (60000 ms)
    setInterval(updateAgenda, 60000);
  </script>
</body>
</html>
